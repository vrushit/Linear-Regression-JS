const fs = require('fs');
const path = require('path');
const axios = require('axios');

async function _plot({ x, y, name = 'plot', ...rest }) {
  const url = 'http://104.248.117.252/plot';

  let data = { x, ...rest };
  if (y) {
    data.y = y;
  }

  try {
    const response = await axios({
      method: 'POST',
      url: url,
      data,
      responseType: 'stream'
    });

    response.data.pipe(
      fs.createWriteStream(path.resolve(process.cwd(), `${name}.png`))
    );

    return new Promise((resolve, reject) => {
      response.data.on('end', () => {
        resolve();
      });

      response.data.on('error', () => {
        reject();
      });
    });
  } catch (e) {
    console.error(e.message);
  }
}

module.exports = function plot({ x, y, ...rest }) {
  if (!Array.isArray(x)) {
    throw new Error('x must be an array of numbers');
  }
  if (y && !Array.isArray(y)) {
    throw new Error('y must be an array of numbers');
  }
  if (x && y && x.length !== y.length) {
    throw new Error('x and y must be the same length');
  }

  return _plot({ x, y, ...rest }).catch(console.error);
};
